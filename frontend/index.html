<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Topolog√≠a CORPOELEC</title>
  <link rel="stylesheet" href="./style.css" />
  <meta name="color-scheme" content="light dark" />
  <link rel="shortcut icon" href="https://i.ibb.co/XfLMNJG2/NTN-Consultores-Corpoelec-logo-2-removebg-preview.png" type="image/x-icon">
  <script>
    (function() {
      try {
        var ls = localStorage.getItem('theme');
        var mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        var theme = ls || (mql && mql.matches ? 'dark' : 'light');
        document.documentElement.dataset.theme = theme;
        document.documentElement.style.colorScheme = theme;
      } catch (e) {}
    })();
  </script>
  <script>
    // Guard temprano: si no hay access ni refresh v√°lidos, manda a login
    (function(){
      try{
        function expired(t){ if(!t) return true; var p=JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))); var now=Math.floor(Date.now()/1000); return !p.exp || p.exp < now; }
        var a = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
        var r = localStorage.getItem('refreshToken') || sessionStorage.getItem('refreshToken');
        if (( !a || expired(a) ) && ( !r || expired(r) )) { location.replace('./login.html'); }
      }catch(e){}
    })();
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>  
</head>
<body>

  <input class="visually-hidden" type="radio" id="tab-wifi" name="tab" checked>
  <input class="visually-hidden" type="radio" id="tab-switches" name="tab">

  <header class="app-header">
    <div class="brand">
      <div class="logo" aria-hidden="true"><img src="https://i.ibb.co/XfLMNJG2/NTN-Consultores-Corpoelec-logo-2-removebg-preview.png" alt="Logo Corpoelec"></div>
      <div class="titles">
        <h1 class="app-title">Topolog√≠a CORPOELEC</h1>
        <p class="app-subtitle">Visualizador de redes</p>
      </div>
    </div>

  <nav class="controls">
    <div class="tabs">
      <label for="tab-wifi" class="tab tab--wifi" title="Ver redes WiFi">Servicio WiFi</label>
      <label for="tab-switches" class="tab tab--switches" title="Ver redes de switches">Red Corporativa</label>
    </div>

    <div class="toolbar">
      <div class="tool-group">
        <button class="btn" type="button" id="fit-view" title="Ajustar vista">Centrar</button>
      </div>
      <div class="tool-group">
      <button class="btn" type="button" id="export-excel">Exportar a Excel</button>
    </div>
      <div class="tool-group">
        <button class="btn" type="button" id="add-device" title="Agregar dispositivo">+ Dispositivo</button>     
        <button class="btn" type="button" id="connect-ports-btn" title="Conectar puertos">Conectar Puertos</button>
      </div>
      <div class="tool-group">
        <input class="search" type="search" id="device-search" placeholder="Buscar dispositivo..." aria-label="Buscar dispositivo" />
      </div>
    </div>

  </nav>
    <div class="session">
      <button id="theme-toggle" class="theme-toggle" type="button" aria-pressed="false" aria-label="Cambiar tema">
        <span class="theme-toggle__icon theme-toggle__icon--sun" aria-hidden="true">‚òÄÔ∏è</span>
        <span class="theme-toggle__icon theme-toggle__icon--moon" aria-hidden="true">üåô</span>
      </button>
      <span id="user-badge" class="user-badge" title="Estado de sesi√≥n">Invitado</span>
      <button id="logout-btn" class="btn" type="button" style="cursor:pointer">Cerrar sesi√≥n</button>
    </div>

    <div class="modal" id="login-modal" aria-hidden="true" role="dialog" aria-labelledby="login-title" aria-modal="true" hidden>
      <div class="modal-backdrop" data-close="modal"></div>
      <div class="modal-dialog" role="document">
        <button class="modal-close" id="login-close" aria-label="Cerrar">√ó</button>
        <h2 id="login-title">Iniciar sesi√≥n</h2>
        <form id="login-form" autocomplete="on">
          <label for="login-username">Usuario</label>
          <input name="username" id="login-username" required autocomplete="username" inputmode="text" />
          <label for="login-password">Contrase√±a</label>
          <input name="password" id="login-password" type="password" required autocomplete="current-password" />
          <label class="checkbox">
            <input type="checkbox" id="remember" />
            Recordarme en este equipo
          </label>
          <div class="form-actions">
            <button type="submit" class="btn btn--primary" id="login-submit">Entrar</button>
            <button type="button" class="btn" id="login-cancel">Cancelar</button>
          </div>
          <p class="form-hint">Usa tus credenciales configuradas en el backend.</p>
          <p class="form-error" id="login-error" role="alert" hidden></p>
        </form>
      </div>
    </div>

    <div class="modal" id="device-modal" aria-hidden="true" role="dialog" aria-labelledby="device-title" aria-modal="true" hidden>
      <div class="modal-backdrop" data-close="modal"></div>
      <div class="modal-dialog modal-dialog--device">  
        <button class="modal-close" id="device-close" aria-label="Cerrar">√ó</button>
        <h2 id="device-title">Agregar/Editar Dispositivo</h2>
        <form id="device-form" autocomplete="off" class="form-grid">  
          <input type="hidden" id="device-id" />
    
      
          <div class="form-group">
            <label for="device-name">Nombre</label>
            <input name="name" id="device-name" required />
          </div>
    
          <div class="form-group">
            <label for="device-type">Tipo</label>
            <select id="device-type" required>
              <option value="">Seleccionar...</option>
              <option value="ap">AP</option>
              <option value="switch">Switch</option>
            </select>
          </div>
    
          <div class="form-group">
            <label for="device-ip">IP</label>
            <input name="ip_address" id="device-ip" type="text" />
          </div>
    
          <div class="form-group">
            <label for="device-mac">MAC</label>
            <input name="mac_address" id="device-mac" type="text" />
          </div>
    
          <div class="form-group">
            <label for="device-location">Ubicaci√≥n</label>
            <input name="location" id="device-location" type="text" />
          </div>
          <div class="form-group">
            <label for="device-ports-count">N√∫mero de Puertos</label>
            <input type="number" id="device-ports-count" min="0" max="48" />
          </div>
    
          <div class="form-group">
            <label for="device-ports-type">Tipo de Puertos</label>
            <select id="device-ports-type">
              <option value="fast-ethernet">Fast Ethernet</option>
              <option value="gigabit-ethernet">Gigabit Ethernet</option>
              <option value="wifi">WiFi</option>
            </select>
          </div>
    
          <div class="form-group form-group--full">
            <label for="device-image">Imagen (opcional)</label>
            <input type="file" id="device-image" accept="image/*" />
            <div id="image-preview" style="margin-top: 10px; display: none;">
              <img id="preview-img" style="max-width: 100px; max-height: 100px; border: 1px solid var(--border); border-radius: 8px;" alt="Vista previa" />
              <button type="button" id="remove-image" style="margin-left: 10px; padding: 4px 8px; border-radius: 4px;">Quitar</button>
            </div>
          </div>
    
          <div class="form-actions">
            <button type="submit" class="btn btn--primary" id="device-submit">Guardar</button>
            <button type="button" class="btn" id="device-cancel">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
    

<div class="modal" id="connection-modal" aria-hidden="true" role="dialog" aria-labelledby="connection-title" aria-modal="true" hidden>
  <div class="modal-backdrop" data-close="modal"></div>
  <div class="modal-dialog">
    <button class="modal-close" id="connection-close" aria-label="Cerrar">√ó</button>
    <h2 id="connection-title">Agregar/Editar Conexi√≥n</h2>
    <form id="connection-form" autocomplete="off">
      <input type="hidden" id="connection-id" />

      <label for="connection-from">Desde (ID)</label>
      <select name="from_device_id" id="connection-from" required>
        <option value="">Seleccionar dispositivo...</option>
      </select>      
      <label for="connection-to">Hasta (ID)</label>
      <select name="to_device_id" id="connection-to" required>
        <option value="">Seleccionar dispositivo...</option>
      </select>

      <label for="connection-link-type">Tipo de Enlace</label>
      <input name="link_type" id="connection-link-type" />
      <label for="connection-status">Estado</label>
      <select id="connection-status">
        <option value="unknown">Desconocido</option>
        <option value="up">Activo</option>
        <option value="down">Inactivo</option>
      </select>
      <div class="form-actions">
        <button type="submit" class="btn btn--primary" id="connection-submit">Guardar</button>
        <button type="button" class="btn" id="connection-cancel">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-labelledby="confirm-title" aria-modal="true" hidden>
  <div class="modal-backdrop" data-close="modal"></div>
  <div class="modal-dialog">
    <h2 id="confirm-title">Confirmar Acci√≥n</h2>
    <p id="confirm-message"></p>
    <div class="form-actions">
      <button type="button" class="btn btn--danger" id="confirm-yes">S√≠</button>
      <button type="button" class="btn" id="confirm-no">No</button>
    </div>
  </div>
</div>
  </header>

  <main class="app-main">
    <section class="canvas-frame" aria-label="Lienzo de topolog√≠a">
      <div class="canvas-inner">
        <div class="view view--wifi" id="view-wifi">
          <div id="canvas-wifi" class="layer layer--nodes"></div>
        </div>
        <div class="view view--switches" id="view-switches">
          <div id="canvas-switches" class="layer layer--nodes"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="footer-left">
      <span class="status-dot status--unknown"></span>
      <span class="status-text">Servidor OK ‚Ä¢ ‚Äî</span>
    </div>
    <div class="footer-right">‚Ä¶</div>
  </footer>

  <script src="./auth.js"></script>
  <script src="./data.js"></script>
  <script src="https://unpkg.com/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
  <script src="./canvas.js"></script>
  <script src="./app.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <div id="context-menu" class="context-menu" hidden>
    <button id="details-btn">Detalles</button>
    <button id="edit-btn">Editar</button>
    <button id="delete-btn">Eliminar</button>
  </div>
  
  <div class="modal" id="details-modal" aria-hidden="true" role="dialog" aria-labelledby="details-title" aria-modal="true" hidden>
    <div class="modal-backdrop" data-close="modal"></div>
    <div class="modal-dialog modal-dialog--device">
      <button class="modal-close" id="details-close" aria-label="Cerrar">√ó</button>
      <h2 id="details-title">Detalles del Dispositivo</h2>
  
      <div id="details-content" style="display: grid; gap: 12px; grid-template-columns: 120px 1fr;">
        <div id="details-image"></div>

        <div id="details-main">
          <div id="details-general" style="margin-bottom: 8px;"></div>
  
          <div id="details-ports-summary" style="margin-bottom: 8px;"></div>
  
          <div id="details-ports-list" style="max-height: 240px; overflow:auto; border-top:1px solid var(--border); padding-top:8px;"></div>
        </div>
      </div>
  
      <div class="form-actions" style="margin-top: 14px;">
        <button type="button" class="btn" id="details-close-2">Cerrar</button>
      </div>
    </div>
  </div>
</body>
</html>